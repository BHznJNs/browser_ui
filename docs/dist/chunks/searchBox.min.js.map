{"version":3,"file":"searchBox.min.js","sources":["../../../frontend/components/fullscreen.js","../../../frontend/components/searchBox.js"],"sourcesContent":["import el from \"../utils/dom/el.js\"\r\n\r\nclass FullscreenMask extends HTMLElement {\r\n    constructor() {\r\n        super()\r\n    }\r\n}\r\ncustomElements.define(\"fullscreen-mask\", FullscreenMask)\r\n\r\nexport default class FullscreenView extends HTMLElement {\r\n    constructor() {\r\n        super()\r\n\r\n        const mask = new FullscreenMask()\r\n        mask.addEventListener(\"click\", () =>\r\n            this.toggle(false))\r\n\r\n        const container = el(\"div\", \"\", {\r\n            \"class\": \"container\"\r\n        })\r\n\r\n        this.classList.add(\"fullscreen\")\r\n        this.mask = mask\r\n        this.container = container\r\n        this.appendChild(mask)\r\n        this.appendChild(container)\r\n    }\r\n\r\n    appendToContainer(el) {\r\n        this.container.appendChild(el)\r\n    }\r\n\r\n    toggle(force) {\r\n        this.mask.classList.toggle(\"show\", force)\r\n        this.container.classList.toggle(\"show\", force)\r\n        this.toggleCallback(force)\r\n    }\r\n    toggleCallback(force) {}\r\n}\r\ncustomElements.define(\"fullscreen-view\", FullscreenView)\r\n","import \"../styles/components/searchBox.css\"\r\nimport FullscreenView from \"./fullscreen.js\"\r\nimport importStyle from \"../scripts/importers/style.js\"\r\nimport pathManager from \"../scripts/pathManager.js\"\r\nimport flexsearch from \"../libs/flexsearch/flexsearch.bundle.module.min.js\"\r\nimport languageSelector from \"../utils/languageSelector.js\"\r\nimport el from \"../utils/dom/el.js\"\r\nimport { tokenize } from \"../../common/countWord.js\"\r\nimport throttle from \"../../common/throttle.js\"\r\nimport eventbus from \"../../common/eventbus/inst.js\"\r\n\r\nfunction indexFactory(indexData) {\r\n    const index = new flexsearch.Index({\r\n        preset: \"memory\",\r\n        optimize: true,\r\n        encode: tokenize,\r\n    })\r\n\r\n    if (indexData !== undefined) {\r\n        for (const [key, data] of Object.entries(indexData)) {\r\n            index.import(key, data)\r\n        }\r\n    }\r\n    return index\r\n}\r\n\r\nclass PageController {\r\n    pageList = []\r\n    maximum = 0\r\n    current = 0\r\n\r\n    #search(id, query) {\r\n        const {index, idMap} = this.pageList[id]\r\n        const searchResult = index.search(query)\r\n        return searchResult.map(itemIndex => idMap[itemIndex])\r\n    }\r\n\r\n    async #importer(id) {\r\n        const file = await fetch(`./.index/search-index_${id}.json`)\r\n        const json = await file.json()\r\n        const { idMap, maxId, ...indexData } = json\r\n\r\n        this.maximum = maxId\r\n        this.pageList.push({\r\n            idMap,\r\n            index: indexFactory(indexData)\r\n        })\r\n    }\r\n\r\n    get hasMorePage() {\r\n        return this.current < this.maximum\r\n    }\r\n\r\n    async search(query) {\r\n        const id = this.current\r\n\r\n        if (this.pageList[id] === undefined) {\r\n            // is not imported page, import it\r\n            await this.#importer(id)\r\n        }\r\n        return this.#search(id, query)\r\n    }\r\n\r\n    async searchNext(query) {\r\n        this.current += 1\r\n        return await this.search(query)\r\n    }\r\n}\r\n\r\nclass SearchBox extends FullscreenView {\r\n    pageController = new PageController\r\n    resultCount = 0\r\n\r\n    constructor() {\r\n        super()\r\n\r\n        importStyle(\"./dist/chunks/searchBox.min.css\")\r\n\r\n        this.input = el(\"input\", \"\", {\r\n            type: \"text\",\r\n            placeholder: languageSelector(\"搜索\", \"Search\"),\r\n        })\r\n        this.searchBtn = el(\"button\", el(\"img\", \"\", {\r\n            src: \"./dist/imgs/search.svg\"\r\n        }), {\r\n            \"class\": \"icon-btn search-btn\",\r\n            title: languageSelector(\"搜索图标\", \"Search Icon\")\r\n        })\r\n\r\n        const inputGroup = el(\"div\", [this.input, this.searchBtn], {\r\n            \"class\": \"input-group\"\r\n        })\r\n        const noResultText = el(\"p\", languageSelector(\"无结果\", \"No search result\"), {\r\n            \"class\": \"no-result\"\r\n        })\r\n\r\n        this.loadMoreBtn = el(\r\n            \"button\",\r\n            languageSelector(\"加载更多\", \"Load More\"), {\r\n            \"class\": \"icon-btn loadmore-btn\"\r\n        })\r\n        this.resultList = el(\"ul\", \"\")\r\n        this.resultContainer = el(\"div\", [\r\n            this.resultList,\r\n            noResultText,\r\n            this.loadMoreBtn,\r\n        ], {\r\n            \"class\": \"result-container\"\r\n        })\r\n\r\n        this.appendToContainer(inputGroup)\r\n        this.appendToContainer(this.resultContainer)\r\n        this.#appendEvents()\r\n        this.toggleCallback(false)\r\n    }\r\n\r\n    toggleCallback(force) {\r\n        const focusableElements = [\r\n            this.input,\r\n            this.searchBtn,\r\n            this.loadMoreBtn,\r\n            ...this.resultList.children,\r\n        ]\r\n        const tabIndex = force ? 0 : -1\r\n        for (const el of focusableElements) {\r\n            el.tabIndex = tabIndex\r\n        }\r\n    }\r\n\r\n    clear() {\r\n        this.resultCount = 0\r\n        this.pageController.current = 0\r\n        this.resultList.innerHTML = \"\"\r\n        this.resultContainer.classList.remove(\"show\")\r\n    }\r\n\r\n    #showSearchResults(searchResult) {\r\n        const itemElFactory = content =>\r\n            el(\"li\", el(\"span\", content, {\r\n                \"class\": \"underline-target\"\r\n            }), {\r\n                \"class\": \"underline-through\",\r\n                tabindex: 0,\r\n            })\r\n\r\n        const frac = document.createDocumentFragment()\r\n        this.resultCount += searchResult.length\r\n        searchResult\r\n            .map(itemElFactory)\r\n            .forEach(el => frac.appendChild(el))\r\n        this.resultList.appendChild(frac)\r\n        this.resultContainer.classList.add(\"show\")\r\n\r\n        this.loadMoreBtn.disabled = false\r\n        this.loadMoreBtn.classList.toggle(\"show\", this.pageController.hasMorePage)\r\n\r\n        if (this.resultCount < 10 && this.pageController.hasMorePage) {\r\n            setTimeout(() => this.#loadMore(), 100)\r\n        }\r\n    }\r\n\r\n    #loadMore() {\r\n        const searchText = this.input.value\r\n        this.loadMoreBtn.disabled = true\r\n        this.pageController.searchNext(searchText)\r\n            .then(this.#showSearchResults.bind(this))\r\n    }\r\n\r\n    #appendEvents() {\r\n        // when open, focus on the input\r\n        eventbus.on(\"searchbox-show\", () => {\r\n            this.toggle(true)\r\n            this.container.addEventListener(\r\n                \"transitionend\",\r\n                () => this.input.focus(),\r\n                { once: true },\r\n            )\r\n        })\r\n\r\n        // open article\r\n        this.resultList.addEventListener(\"click\", e => {\r\n            const target = e.target\r\n            if (target === this.resultList) {\r\n                return\r\n            }\r\n            const targetArticle = \"static/\" + target.textContent\r\n            pathManager.jumpTo(targetArticle)\r\n            this.toggle(false)\r\n        })\r\n\r\n        // clear search result when `input`is empty\r\n        this.input.addEventListener(\"input\", this.clear.bind(this))\r\n\r\n        // `Enter` key or click the search button to start search\r\n        const searchThrottled = throttle(() => {\r\n            this.clear()\r\n            const searchText = this.input.value\r\n            this.pageController.search(searchText)\r\n                .then(this.#showSearchResults.bind(this))\r\n        }, 500)\r\n        this.searchBtn.addEventListener(\"click\", searchThrottled)\r\n        this.input.addEventListener(\"keydown\", e => {\r\n            if (e.key !== \"Enter\") {\r\n                return\r\n            }\r\n            searchThrottled()\r\n        })\r\n\r\n        // load more button click event\r\n        this.loadMoreBtn.addEventListener(\"click\", this.#loadMore.bind(this))\r\n    }\r\n}\r\ncustomElements.define(\"search-box\", SearchBox)\r\n"],"names":["FullscreenMask","HTMLElement","constructor","super","customElements","define","FullscreenView","mask","addEventListener","this","toggle","container","el","class","classList","add","appendChild","appendToContainer","force","toggleCallback","indexFactory","indexData","index","flexsearch","Index","preset","optimize","encode","tokenize","undefined","key","data","Object","entries","import","PageController","pageList","maximum","current","search","id","query","idMap","map","itemIndex","importer","file","fetch","json","maxId","push","hasMorePage","searchNext","pageController","resultCount","importStyle","input","type","placeholder","languageSelector","searchBtn","src","title","inputGroup","noResultText","loadMoreBtn","resultList","resultContainer","appendEvents","focusableElements","children","tabIndex","clear","innerHTML","remove","showSearchResults","searchResult","frac","document","createDocumentFragment","length","content","tabindex","forEach","disabled","setTimeout","loadMore","searchText","value","then","bind","eventbus","on","focus","once","e","target","targetArticle","textContent","pathManager","jumpTo","searchThrottled","throttle"],"mappings":"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"}